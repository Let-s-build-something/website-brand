name: Distribute Web to FTP

on:
  push:
    branches: [ "release" ]

jobs:
  build:
    runs-on: ubuntu-latest  # Use Ubuntu instead of Windows

    steps:
      # Step 1: Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # Step 3: Prepare access to everything
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Step 4: Run WasmJsBrowserDistribution script to generate web assembly files
      - name: Run WasmJsBrowserDistribution
        run: ./gradlew wasmJsBrowserDistribution

      # Step 5: Compress .wasm files with gzip
      - name: Compress .wasm files with gzip
        run: |
          wasm_dir="${{ github.workspace }}/composeApp/build/dist/wasmJs/productionExecutable"
          find "$wasm_dir" -type f -name "*.wasm" -exec gzip -k {} \;

      # Step 6: Remove .wasm.gz files from FTP
      - name: Remove .wasm.gz files from FTP
        run: |
          ftp_server="${{ secrets.FTP_SERVER_DOMAIN }}"
          ftp_username="${{ secrets.FTP_USERNAME }}"
          ftp_password="${{ secrets.FTP_PASSWORD }}"

          # List .wasm.gz files on FTP
          wasm_gz_files=$(curl -s -u "${ftp_username}:${ftp_password}" "ftp://$ftp_server/www/" --list-only | grep '\.wasm\.gz$')

          if [ -z "$wasm_gz_files" ]; then
              echo "No .wasm.gz files found on FTP server."
          else
              # Delete each .wasm.gz file
              for file in $wasm_gz_files; do
                  echo "Deleting $file..."
                  curl -u "${ftp_username}:${ftp_password}" "ftp://$ftp_server/www/$file" --request DELETE
              done
          fi

      # Step 7: Remove .wasm.gz files from FTP
      - name: Remove .wasm.gz files from FTP
        run: |
          ftp_server="${{ secrets.FTP_SERVER_DOMAIN }}"
          ftp_username="${{ secrets.FTP_USERNAME }}"
          ftp_password="${{ secrets.FTP_PASSWORD }}"
          
          # List .wasm.gz files on FTP
          wasm_gz_files=$(curl -s -u "${ftp_username}:${ftp_password}" "ftp://$ftp_server/www/" --list-only | grep '\.wasm\.gz$')
          
          if [ -z "$wasm_gz_files" ]; then
              echo "No .wasm.gz files found on FTP server."
          else
              # Delete each .wasm.gz file
              echo "$wasm_gz_files" | while read -r file; do
                  if [ -n "$file" ]; then
                      echo "Deleting $file..."
                      curl -u "${ftp_username}:${ftp_password}" -Q "DELE /www/$file" "ftp://$ftp_server/"
                  fi
              done
          fi